# 🔧 システム修正計画書

**作成日**: 2025年10月19日  
**基準**: システム仕様書v2.0  
**目的**: 料金プラン別メニュー・シート表示制御システムの段階的実装

---

## 🎯 修正計画概要

### 基本方針
1. **既存機能を維持** - 現在動作している機能は破綻させない
2. **段階的実装** - 一度に大きな変更を行わず、段階的に機能追加
3. **仕様書準拠** - システム仕様書v2.0の料金プラン仕様に厳密準拠
4. **後方互換性** - 既存のライセンス管理システムとの併存

---

## 📋 現在のコード分析結果

### ✅ 活用可能な既存コード
```javascript
// 1. ライセンス管理基盤（license-manager.js）
- ✅ 管理者認証システム（ADMIN_PASSWORD）
- ✅ ライセンス期限管理（10営業日）
- ✅ シート管理機能
- 🔄 拡張必要: プラン管理機能

// 2. ユーザー権限管理（user-manager.js）
- ✅ 3段階権限制御（管理者・スタンダード・ゲスト）
- ✅ セッション管理（8時間タイムアウト）
- ✅ ユーザー管理シート
- 🔄 拡張必要: プラン権限統合

// 3. メニューシステム（main-menu.js）
- ✅ 仕様書v2.0準拠メニュー
- ✅ 管理者・一般ユーザー分離
- ✅ ガバナンスチェック
- 🔄 拡張必要: プラン別動的メニュー生成
```

### 🆕 新規作成必要なファイル
```javascript
// 1. plan-manager.js（料金プラン管理）
- プラン判定・切り替えシステム
- 使用量追跡システム
- プラン制限チェック

// 2. usage-tracker.js（使用量追跡）
- 日次使用量管理
- API使用量カウント
- 制限値チェック

// 3. sheet-visibility.js（シート表示制御）
- プラン別シート表示・非表示
- 権限別アクセス制御
- 動的シート管理

// 4. state-manager.js（統合状態管理）
- 管理者権限・プラン統合管理
- ワンクリック切り替え
- 状態履歴管理
```

---

## 🚀 段階的実装計画

### Phase 0: 基盤準備（即座実行）
#### 目標: 既存システムとの統合基盤構築

**実装タスク:**
```bash
1. plan-manager.js 作成
   - getUserPlan() 基本実装
   - getPlanLimits() 制限値定義
   - 既存ライセンス管理との連携

2. 既存コード拡張ポイント特定
   - license-manager.js → プラン管理統合
   - main-menu.js → 動的メニュー生成準備
   - user-manager.js → プラン権限統合

3. システム設定シート拡張
   - プラン管理項目追加
   - 状態管理項目追加
```

**成果物:**
- `src/plan-manager.js`（基本機能）
- 既存ファイルへの統合ポイント追加
- システム設定シート拡張

**検証方法:**
- プラン判定機能の基本動作確認
- 既存機能の非破綻確認

---

### Phase 1: 使用量制限システム（1-2日）
#### 目標: 日次使用量追跡とプラン制限の実装

**実装タスク:**
```bash
1. usage-tracker.js 作成
   - UsageTracker クラス実装
   - 日次使用量カウント機能
   - 自動リセット機能（トリガー設定）

2. 制限チェック機能
   - checkPlanLimit() 実装
   - 企業検索制限チェック
   - API使用量制限チェック

3. エラーハンドリング
   - 制限超過時のユーザー通知
   - アップグレード案内ダイアログ
   - 制限リセット時刻案内
```

**成果物:**
- `src/usage-tracker.js`
- 制限チェック機能統合
- エラーダイアログ実装

**検証方法:**
- 各プランでの制限値動作確認
- 日次リセット機能確認
- 制限超過時の適切な通知確認

---

### Phase 2: 動的メニューシステム（2-3日）
#### 目標: プラン別メニュー表示制御の実装

**実装タスク:**
```bash
1. main-menu.js 拡張
   - createPlanBasedMenu() 実装
   - プラン別メニュー項目制御
   - 制限表示テキスト動的生成

2. メニュー制御ロジック
   - 各プランでのメニュー差分実装
   - 試用期間カウントダウン表示
   - 管理者モード統合

3. UI/UX 改善
   - プラン名表示
   - 制限状況の視覚的フィードバック
   - アップグレード案内統合
```

**成果物:**
- プラン別動的メニューシステム
- 制限状況表示機能
- 統合UI改善

**検証方法:**
- 全プランでのメニュー表示確認
- 制限機能の適切な非表示確認
- 管理者モードとの併存確認

---

### Phase 3: シート表示制御（2-3日）
#### 目標: プラン別シート表示・非表示制御

**実装タスク:**
```bash
1. sheet-visibility.js 作成
   - controlSheetVisibility() 実装
   - プラン別シート制御マトリックス
   - 管理者権限との統合制御

2. 制限表示機能
   - ベーシックプラン制限表示
   - アップグレード案内シート内表示
   - 拡張シート（パフォーマンス分析等）制御

3. 動的シート管理
   - プラン変更時の即座シート更新
   - シートアクセス権限制御
   - シート内容の動的制限表示
```

**成果物:**
- `src/sheet-visibility.js`
- プラン別シート表示制御システム
- 制限表示機能

**検証方法:**
- 全プランでのシート表示確認
- 管理者シートのアクセス制御確認
- プラン変更時の即座反映確認

---

### Phase 4: 統合切り替えシステム（3-4日）
#### 目標: ワンクリック切り替え制御パネルの実装

**実装タスク:**
```bash
1. state-manager.js 作成
   - SystemStateManager クラス実装
   - 管理者権限・プラン統合管理
   - 状態履歴管理

2. 制御パネル統合UI
   - ワンクリック切り替えボタン
   - プリセットモード（デモ・テスト・サポート・開発）
   - 状態履歴表示

3. セルクリック連動システム
   - onEdit() イベント統合
   - セルクリック→状態変更
   - 視覚的フィードバック
```

**成果物:**
- `src/state-manager.js`
- 統合制御パネルUI
- ワンクリック切り替えシステム

**検証方法:**
- 全切り替えパターンの動作確認
- 状態復元機能の確認
- UI/UXの使いやすさ検証

---

### Phase 5: 最終統合・最適化（1-2日）
#### 目標: 全機能の統合とパフォーマンス最適化

**実装タスク:**
```bash
1. 統合テスト
   - 全プラン・全機能の組み合わせテスト
   - 権限・プラン・制限の複合テスト
   - エラーケースの網羅テスト

2. パフォーマンス最適化
   - API呼び出し最適化
   - キャッシュ機能実装
   - UI応答速度改善

3. ドキュメント完成
   - 実装ドキュメント作成
   - 運用マニュアル更新
   - トラブルシューティングガイド
```

**成果物:**
- 完全統合システム
- 最適化済みパフォーマンス
- 完全ドキュメント

**検証方法:**
- 包括的システムテスト
- パフォーマンス計測
- ユーザビリティテスト

---

## ⚙️ 技術的統合ポイント

### 既存システムとの連携
```javascript
// 1. ライセンス管理システム連携
function isSystemActive() {
  const licenseInfo = getLicenseInfo();  // 既存関数活用
  const planInfo = getUserPlanInfo();    // 新規関数
  
  return !licenseInfo.isExpired && planInfo.isActive;
}

// 2. ユーザー権限システム連携
function getEffectivePermissions() {
  const userRole = getCurrentUser().role;    // 既存関数
  const userPlan = getUserPlan();           // 新規関数
  
  return combinePermissions(userRole, userPlan);
}

// 3. メニューシステム統合
function createUnifiedMenu() {
  const isAdmin = isAdminUser();         // 既存関数
  const planLimits = getPlanLimits();    // 新規関数
  
  return buildDynamicMenu(isAdmin, planLimits);
}
```

### データ管理統合
```javascript
// 既存のPropertiesService活用
const PLAN_PROPERTIES = {
  USER_PLAN: 'user_plan',
  ORIGINAL_PLAN: 'original_plan', 
  SWITCH_MODE: 'switch_mode',
  USAGE_DATA: 'daily_usage_data'
};

// 既存のシート管理システム拡張
function getSystemConfigSheet() {
  return getSafeSheet('システム設定');  // 既存関数活用
}
```

---

## 🎯 成功指標

### Phase完了基準
1. **Phase 0**: プラン判定・制限値取得が正常動作
2. **Phase 1**: 全プランで使用量制限が適切に機能
3. **Phase 2**: プラン別メニューが正確に表示・制御される
4. **Phase 3**: シート表示がプラン・権限に応じて適切に制御
5. **Phase 4**: ワンクリック切り替えがスムーズに動作
6. **Phase 5**: 全機能が統合され、安定動作する

### 品質基準
- 既存機能の100%維持
- 新機能の仕様書100%準拠
- ユーザー体験の向上（混乱・エラーの削減）
- システムパフォーマンスの維持

---

## ⚠️ リスク・注意点

### 技術的リスク
1. **既存機能への影響** - 段階的実装とテストで最小化
2. **パフォーマンス低下** - キャッシュ・最適化で対策
3. **データ整合性** - 既存データ構造の慎重な拡張

### 運用リスク
1. **ユーザー混乱** - 段階的リリースと丁寧な案内
2. **機能複雑化** - シンプルなUI/UX設計
3. **サポート負荷** - 包括的ドキュメント・FAQ整備

---

## 📅 実装スケジュール

```
Day 1-2:  Phase 0 (基盤準備)
Day 3-4:  Phase 1 (使用量制限)
Day 5-7:  Phase 2 (動的メニュー)
Day 8-10: Phase 3 (シート制御)
Day 11-14: Phase 4 (統合切り替え)
Day 15-16: Phase 5 (最終統合)
```

**総所要期間**: 約16営業日（3週間強）  
**リリース予定**: 2025年11月中旬