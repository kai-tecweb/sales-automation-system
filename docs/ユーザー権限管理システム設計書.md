# 🔐 ユーザー権限管理システム設計書

**作成日:** 2025年10月18日  
**バージョン:** v1.0  

## 🎯 システム概要

営業自動化システムにおける3段階ユーザー権限システムの詳細設計。
各ユーザーロールに応じた機能アクセス制御とデータ保護を実現する。

## 👥 ユーザーロール定義

### 1. 🔑 管理者（Administrator）
**権限レベル:** 最高
**認証方法:** パスワード認証（`SalesAuto2024!`）

**アクセス可能機能:**
- ✅ 全システム機能
- ✅ ライセンス管理
- ✅ API設定・管理
- ✅ ユーザー管理
- ✅ システム設定・診断
- ✅ データ完全アクセス
- ✅ シート作成・削除
- ✅ システムロック・解除

### 2. 👤 スタンダードユーザー（Standard User）
**権限レベル:** 中
**認証方法:** ユーザー名/パスワード

**アクセス可能機能:**
- ✅ 基本営業自動化機能
  - キーワード生成
  - 企業検索
  - 提案メッセージ生成
- ✅ データ閲覧・編集（自分のデータのみ）
- ✅ レポート生成
- ❌ システム設定変更
- ❌ 他ユーザーデータアクセス
- ❌ API設定変更

### 3. 👁️ ゲストユーザー（Guest User）
**権限レベル:** 最低
**認証方法:** なし（デフォルトモード）

**アクセス可能機能:**
- ✅ データ閲覧のみ（読み取り専用）
- ✅ レポート表示
- ❌ データ作成・編集・削除
- ❌ システム機能実行
- ❌ 設定変更

## 🗂️ データアクセス制御

### シート別アクセス権限

| シート名 | 管理者 | スタンダード | ゲスト |
|---------|-------|------------|-------|
| 制御パネル | 読書 | 読み専用 | 読み専用 |
| ユーザー管理 | 読書 | 読み専用 | ❌ |
| ライセンス管理 | 読書 | 読み専用 | ❌ |
| 生成キーワード | 読書 | 読書 | 読み専用 |
| 企業マスター | 読書 | 読書 | 読み専用 |
| 提案メッセージ | 読書 | 読書 | 読み専用 |
| 実行ログ | 読書 | 読み専用 | 読み専用 |

## 🔧 技術実装仕様

### 1. ユーザー管理シート構造
```
ユーザー管理シート:
A列: ユーザーID (自動生成)
B列: ユーザー名
C列: パスワード (ハッシュ化)
D列: ロール (Administrator/Standard/Guest)
E列: 作成日時
F列: 最終ログイン
G列: アクティブ状態 (TRUE/FALSE)
H列: 作成者
```

### 2. セッション管理
```javascript
// セッション情報をPropertiesServiceに保存
const SESSION_PROPERTIES = {
  CURRENT_USER: 'CURRENT_USER_ID',
  USER_ROLE: 'CURRENT_USER_ROLE',
  LOGIN_TIME: 'LOGIN_TIMESTAMP',
  SESSION_TIMEOUT: 'SESSION_TIMEOUT'
};
```

### 3. 権限チェック関数
```javascript
function checkUserPermission(requiredRole) {
  const currentRole = getCurrentUserRole();
  const roleHierarchy = {
    'Guest': 1,
    'Standard': 2, 
    'Administrator': 3
  };
  
  return roleHierarchy[currentRole] >= roleHierarchy[requiredRole];
}
```

## 🎨 UI制御仕様

### メニュー表示制御
- **管理者:** 全メニュー表示
- **スタンダード:** 基本機能メニューのみ
- **ゲスト:** 閲覧系メニューのみ

### ボタン/機能制御
- 権限に応じてボタンの有効/無効を動的制御
- 不正アクセス試行時の警告表示
- ログイン状態の常時表示

## 🔐 セキュリティ仕様

### 1. パスワード管理
- SHA-256ハッシュ化
- ソルト付きハッシュ
- 最小8文字、英数字記号必須

### 2. セッション管理
- 自動ログアウト（8時間）
- 不正アクセス検知
- ログイン履歴記録

### 3. データ保護
- 機能実行前の権限チェック
- データアクセス監査ログ
- 重要操作の確認ダイアログ

## 📋 実装優先順位

```
優先度1: ユーザー管理基盤
├── ユーザー管理シート作成
├── 基本権限チェック関数
└── ログイン/ログアウト機能

優先度2: メニュー統合
├── 権限別メニュー表示
├── 既存メニューシステム拡張
└── UI制御実装

優先度3: セキュリティ強化
├── パスワードハッシュ化
├── セッション管理
└── 監査ログ機能
```

## 🔄 既存システムとの統合

### 1. ライセンス管理との連携
- ライセンス有効性とユーザー権限の組み合わせチェック
- 管理者のみライセンス管理可能

### 2. メインメニューシステム拡張
- `main-menu.js` にユーザー権限チェックを統合
- 動的メニュー生成

### 3. API機能との統合
- API実行前の権限確認
- ユーザー別使用量制限

## 🎯 成功指標

### 機能面
- ✅ 3段階権限制御の完全動作
- ✅ 不正アクセスの完全防止
- ✅ ユーザー管理機能の完全実装

### 運用面
- ✅ 直感的なユーザー体験
- ✅ 管理者の簡単なユーザー管理
- ✅ セキュリティインシデント0件

---

**次のステップ:** `src/user-manager.js` の実装開始