/**
 * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½
 * å•†ææƒ…å ±ã‹ã‚‰æˆ¦ç•¥çš„ãªä¼æ¥­æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ
 */

/**
 * æˆ¦ç•¥çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç”Ÿæˆ
 */
function executeKeywordGeneration() {
  try {
    console.log('ğŸ”¤ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...');
    
    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ç¢ºèª
    try {
      console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–çŠ¶æ³ã‚’ç¢ºèªä¸­...');
      const systemStatus = checkSystemStatus();
      console.log('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³:', systemStatus);
      
      if (systemStatus && systemStatus.needsInitialization) {
        throw new Error(`ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${systemStatus.message}`);
      }
    } catch (initError) {
      console.error('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ç¢ºèªã‚¨ãƒ©ãƒ¼:', initError);
      throw new Error(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ${initError.message}`);
    }
    
    updateExecutionStatus('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...');
    
    const settings = getControlPanelSettings();
    console.log('åˆ¶å¾¡ãƒ‘ãƒãƒ«è¨­å®š:', settings);
    
    // å…¥åŠ›å€¤ãƒã‚§ãƒƒã‚¯
    if (!settings.productName || !settings.productDescription) {
      throw new Error('å•†æåã¨å•†ææ¦‚è¦ã¯å¿…é ˆã§ã™');
    }
    
    // ChatGPT APIã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
    const keywords = generateKeywordsWithChatGPT(settings);
    
    // çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
    saveKeywordsToSheet(keywords);
    
    updateExecutionStatus(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†: ${keywords.length}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);
    logExecution('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', 'SUCCESS', keywords.length, 0);
    
    return keywords;
    
  } catch (error) {
    handleSystemError('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', error);
  }
}

/**
 * ChatGPT APIã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
 */
function generateKeywordsWithChatGPT(settings) {
  const prompt = createKeywordGenerationPrompt(settings);
  
  const payload = {
    model: 'gpt-3.5-turbo',
    messages: [
      {
        role: 'system',
        content: 'ã‚ãªãŸã¯å–¶æ¥­æˆ¦ç•¥ã®å°‚é–€å®¶ã§ã™ã€‚å•†ææƒ…å ±ã‹ã‚‰åŠ¹æœçš„ãªä¼æ¥­æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚'
      },
      {
        role: 'user',
        content: prompt
      }
    ],
    max_tokens: 2000,
    temperature: 0.7
  };
  
  const response = callOpenAIAPI(payload);
  return parseKeywordResponse(response);
}

/**
 * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
 */
function createKeywordGenerationPrompt(settings) {
  return `
å•†ææƒ…å ±ï¼š
- å•†æå: ${settings.productName}
- æ¦‚è¦: ${settings.productDescription}
- ä¾¡æ ¼å¸¯: ${settings.priceRange}
- å¯¾è±¡ä¼æ¥­è¦æ¨¡: ${settings.targetSize}
- å„ªå…ˆåœ°åŸŸ: ${settings.preferredRegion || 'æŒ‡å®šãªã—'}

ã‚ãªãŸã¯å–¶æ¥­æˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã“ã®å•†æãŒåˆºã•ã‚Šãã†ãªä¼æ¥­ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æˆ¦ç•¥çš„ã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®4ã¤ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã¦ã€ãã‚Œãã‚Œ10-15å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

1. painPointHunting: èª²é¡Œã‚’æŠ±ãˆã‚‹ä¼æ¥­ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
2. growthTargeting: æˆé•·ã—ã¦ã„ã‚‹ä¼æ¥­ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰  
3. budgetTargeting: äºˆç®—ã®ã‚ã‚‹ä¼æ¥­ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
4. timingCapture: å°å…¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè‰¯ã„ä¼æ¥­ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰

å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ï¼š

{
  "strategicKeywords": {
    "painPointHunting": {
      "keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
      "strategy": "ã“ã®æˆ¦ç•¥ã®èª¬æ˜"
    },
    "growthTargeting": {
      "keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
      "strategy": "ã“ã®æˆ¦ç•¥ã®èª¬æ˜"
    },
    "budgetTargeting": {
      "keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
      "strategy": "ã“ã®æˆ¦ç•¥ã®èª¬æ˜"
    },
    "timingCapture": {
      "keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
      "strategy": "ã“ã®æˆ¦ç•¥ã®èª¬æ˜"
    }
  }
}

ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å…·ä½“çš„ã§æ¤œç´¢ã«åŠ¹æœçš„ãªã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚ä¼æ¥­åã§ã¯ãªãã€çŠ¶æ³ã‚„èª²é¡Œã€æˆé•·æ®µéšã‚’è¡¨ç¾ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚
`;
}

/**
 * OpenAI APIå‘¼ã³å‡ºã—
 */
function callOpenAIAPI(payload) {
  const apiKey = API_KEYS.OPENAI;
  if (!apiKey) {
    throw new Error('OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  }
  
  const options = {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload)
  };
  
  return apiCallWithRetry(() => {
    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', options);
    
    if (response.getResponseCode() !== 200) {
      throw new Error(`OpenAI API Error: ${response.getResponseCode()} - ${response.getContentText()}`);
    }
    
    const data = JSON.parse(response.getContentText());
    return data.choices[0].message.content;
  });
}

/**
 * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹
 */
function parseKeywordResponse(response) {
  try {
    // JSONéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆmarkdownå½¢å¼ã®å ´åˆã«å¯¾å¿œï¼‰
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error('æœ‰åŠ¹ãªJSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    const data = JSON.parse(jsonMatch[0]);
    const strategicKeywords = data.strategicKeywords;
    
    const allKeywords = [];
    
    // å„ã‚«ãƒ†ã‚´ãƒªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é…åˆ—ã«å¤‰æ›
    Object.keys(strategicKeywords).forEach(category => {
      const categoryData = strategicKeywords[category];
      const priority = getPriorityByCategory(category);
      
      categoryData.keywords.forEach(keyword => {
        allKeywords.push({
          keyword: keyword,
          category: category,
          priority: priority,
          strategy: categoryData.strategy,
          executed: false,
          hitCount: 0,
          lastExecuted: ''
        });
      });
    });
    
    return allKeywords;
    
  } catch (error) {
    Logger.log('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
    Logger.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
    throw new Error(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥å„ªå…ˆåº¦ã®æ±ºå®š
 */
function getPriorityByCategory(category) {
  const priorityMap = {
    'painPointHunting': 'é«˜',
    'timingCapture': 'é«˜',
    'growthTargeting': 'ä¸­',
    'budgetTargeting': 'ä¸­'
  };
  
  return priorityMap[category] || 'ä½';
}

/**
 * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
 */
function saveKeywordsToSheet(keywords) {
  const sheet = getSafeSheet(SHEET_NAMES.KEYWORDS);
  if (!sheet) {
    console.error('KEYWORDS sheet not found - cannot save keywords');
    throw new Error('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
  }
  
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ï¼‰
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    sheet.getRange(2, 1, lastRow - 1, 7).clearContent();
  }
  
  // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥
  const dataToInsert = keywords.map(kw => [
    kw.keyword,
    kw.category,
    kw.priority,
    kw.strategy,
    kw.executed,
    kw.hitCount,
    kw.lastExecuted
  ]);
  
  if (dataToInsert.length > 0) {
    sheet.getRange(2, 1, dataToInsert.length, 7).setValues(dataToInsert);
  }
  
  Logger.log(`${keywords.length}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
}

/**
 * APIå‘¼ã³å‡ºã—ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
 */
function apiCallWithRetry(apiFunction, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return apiFunction();
    } catch (error) {
      const errorStr = error.toString();
      
      // APIåˆ¶é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å†è©¦è¡Œ
      if (errorStr.includes('quota') || errorStr.includes('limit') || errorStr.includes('rate_limit')) {
        const waitTime = Math.pow(2, i) * 1000; // 1ç§’, 2ç§’, 4ç§’
        Logger.log(`APIåˆ¶é™æ¤œå‡ºã€‚${waitTime}mså¾…æ©Ÿå¾Œã«å†è©¦è¡Œã—ã¾ã™...`);
        Utilities.sleep(waitTime);
        continue;
      }
      
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯å³åº§ã«ã‚¹ãƒ­ãƒ¼
      throw error;
    }
  }
  
  throw new Error('APIåˆ¶é™ã«ã‚ˆã‚Šå‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
}

/**
 * å®Ÿè¡Œãƒ­ã‚°ã®è¨˜éŒ²
 */
function logExecution(type, status, successCount, errorCount, errorDetails = '') {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.LOGS);
  const lastRow = sheet.getLastRow();
  const executionId = lastRow > 1 ? sheet.getRange(lastRow, 1).getValue() + 1 : 1;
  
  const logData = [
    executionId,
    new Date(),
    type,
    status,
    successCount,
    errorCount,
    errorDetails,
    '', // å‡¦ç†æ™‚é–“ã¯å¾Œã§æ›´æ–°
    1 // APIä½¿ç”¨é‡
  ];
  
  sheet.getRange(lastRow + 1, 1, 1, logData.length).setValues([logData]);
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åç§°ï¼‰
 */
function generateKeywords() {
  try {
    executeKeywordGeneration();
  } catch (error) {
    console.error('âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
    SpreadsheetApp.getUi().alert('âŒ ã‚¨ãƒ©ãƒ¼', `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}
  
  const logData = [
    executionId,
    new Date(),
    type,
    status,
    successCount,
    errorCount,
    errorDetails,
    '', // å‡¦ç†æ™‚é–“ã¯å¾Œã§æ›´æ–°
    1 // APIä½¿ç”¨é‡
  ];
  
  sheet.getRange(lastRow + 1, 1, 1, logData.length).setValues([logData]);
}
